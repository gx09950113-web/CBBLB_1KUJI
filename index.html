<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>一番賞抽獎</title>

  <style>
    :root{
      --bg1:#0a0f2a;
      --bg2:#0b2b5a;
      --txt:#f7f8ff;
      --muted: rgba(255,255,255,.78);
      --line: rgba(255,255,255,.22);

      --accent1:#7c3aed;   /* 紫 */
      --accent2:#22d3ee;   /* 青 */
      --accent3:#f472b6;   /* 粉 */
      --accent4:#fbbf24;   /* 金 */

      --shadow: 0 24px 80px rgba(0,0,0,.40);
      --shadow2: 0 16px 40px rgba(0,0,0,.35);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
      color:var(--txt);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:26px;

      background:
        radial-gradient(900px 500px at 15% 10%, rgba(244,114,182,.35), transparent 60%),
        radial-gradient(1100px 600px at 85% 15%, rgba(34,211,238,.35), transparent 60%),
        radial-gradient(900px 520px at 55% 95%, rgba(124,58,237,.28), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* 漂浮亮點 */
    body:before{
      content:"";
      position:fixed;
      inset:-40px;
      pointer-events:none;
      background:
        radial-gradient(10px 10px at 10% 20%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(12px 12px at 30% 10%, rgba(255,255,255,.25), transparent 60%),
        radial-gradient(9px 9px at 70% 18%, rgba(255,255,255,.30), transparent 60%),
        radial-gradient(11px 11px at 85% 28%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(8px 8px at 60% 86%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(10px 10px at 20% 82%, rgba(255,255,255,.20), transparent 60%);
      opacity:.8;
      animation: floaty 10s ease-in-out infinite alternate;
    }
    @keyframes floaty{ 0%{transform: translateY(0px)} 100%{transform: translateY(14px)} }

    .wrap{width:min(1000px,100%);}

    .hero{
      position:relative;
      border-radius: var(--radius);
      padding:18px 18px 14px;
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;

      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .hero:after{
      content:"";
      position:absolute;
      inset:-2px;
      background: linear-gradient(90deg,
        rgba(244,114,182,.0),
        rgba(244,114,182,.45),
        rgba(34,211,238,.45),
        rgba(124,58,237,.45),
        rgba(244,114,182,.0)
      );
      opacity:.45;
      filter: blur(18px);
      z-index:0;
      animation: shimmer 5.5s linear infinite;
    }
    @keyframes shimmer{ 0%{transform: translateX(-25%)} 100%{transform: translateX(25%)} }
    .hero > *{position:relative; z-index:1;}

    h1{margin:0 0 6px; font-size:20px; letter-spacing:.6px}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.6}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    input{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.28);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      min-width:240px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    input::placeholder{color: rgba(255,255,255,.72)}
    input:focus{
      border-color: rgba(34,211,238,.75);
      box-shadow: 0 0 0 4px rgba(34,211,238,.18), inset 0 0 0 1px rgba(255,255,255,.08);
    }

    button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.28);
      color:var(--txt);
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
      letter-spacing:.3px;
      transition:.15s transform ease, .15s filter ease, .15s box-shadow ease;

      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
      box-shadow: var(--shadow2);
    }
    button:hover{filter:brightness(1.10)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed; filter:saturate(.8)}

    button.primary{
      background: linear-gradient(135deg, rgba(244,114,182,.35), rgba(34,211,238,.30), rgba(124,58,237,.32));
      border-color: rgba(255,255,255,.34);
      box-shadow:
        0 18px 50px rgba(34,211,238,.18),
        0 18px 50px rgba(244,114,182,.16),
        var(--shadow2);
    }
    button.secondary{ background: rgba(255,255,255,.13); }
    button.danger{ background: linear-gradient(135deg, rgba(251,113,133,.40), rgba(244,114,182,.20)); }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap:14px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .panel{
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel .hd{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.18);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(0,0,0,.12);
    }
    .panel .bd{ padding:14px; }

    .tag{
      font-size:12px;
      color: rgba(255,255,255,.86);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      background: rgba(255,255,255,.10);
      white-space:nowrap;
    }

    .reveal{
      position:relative;
      display:grid;
      place-items:center;
      padding:20px 14px 22px;
      min-height:290px;
      background:
        radial-gradient(900px 380px at 50% 0%, rgba(251,191,36,.26), transparent 55%),
        radial-gradient(900px 380px at 30% 20%, rgba(34,211,238,.18), transparent 60%),
        rgba(0,0,0,.10);
      overflow:hidden;
    }

    .card{
      width:min(560px,100%);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.25);
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
      box-shadow: 0 30px 120px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden;
      transform-style:preserve-3d;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: conic-gradient(from 180deg,
        rgba(251,191,36,.0),
        rgba(251,191,36,.65),
        rgba(34,211,238,.55),
        rgba(124,58,237,.55),
        rgba(244,114,182,.55),
        rgba(251,191,36,.65),
        rgba(251,191,36,.0)
      );
      filter: blur(18px);
      opacity:.35;
      pointer-events:none;
    }

    .flash{
      height:10px;
      background: linear-gradient(90deg,
        rgba(251,191,36,.0),
        rgba(251,191,36,.95),
        rgba(34,211,238,.9),
        rgba(244,114,182,.9),
        rgba(124,58,237,.9),
        rgba(251,191,36,.0)
      );
      opacity:0;
    }

    .card .face{
      position:relative;
      padding:18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .face .title{
      font-size:18px;
      font-weight:1000;
      letter-spacing:.7px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }

    .big{
      font-size:30px;
      font-weight:1100;
      line-height:1.1;
      text-shadow: 0 10px 40px rgba(0,0,0,.35);
    }

    .desc{
      color: rgba(255,255,255,.86);
      font-size:14px;
      line-height:1.6;
      white-space:pre-line;
    }

    .who{
      color: #ffffff;
      font-weight:1000;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .note{margin:10px 0 0; color: rgba(255,255,255,.78); font-size:12px; line-height:1.6}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hint{color: rgba(255,255,255,.92)}
    .accentText{
      background: linear-gradient(90deg, rgba(251,191,36,.95), rgba(34,211,238,.95), rgba(244,114,182,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
      font-weight:1100;
    }

    .flip{ animation: flip 900ms cubic-bezier(.2,.85,.2,1) both; }
    @keyframes flip{
      0%{transform: rotateY(0deg) scale(.985); filter:brightness(.95)}
      40%{transform: rotateY(92deg) scale(1.02); filter:brightness(1.08)}
      100%{transform: rotateY(0deg) scale(1); filter:brightness(1)}
    }
    .glow{ animation: glow 1100ms ease-out both; }
    @keyframes glow{
      0%{box-shadow: 0 0 0 rgba(34,211,238,0), 0 0 0 rgba(251,191,36,0)}
      35%{
        box-shadow:
          0 0 110px rgba(34,211,238,.18),
          0 0 110px rgba(251,191,36,.16),
          0 30px 120px rgba(0,0,0,.55);
      }
      100%{box-shadow: 0 30px 120px rgba(0,0,0,.55)}
    }
    .flash.on{opacity:1; animation: flash 650ms ease-out both;}
    @keyframes flash{
      0%{transform:translateX(-60%); opacity:0}
      45%{opacity:1}
      100%{transform:translateX(60%); opacity:0}
    }

    table{width:100%; border-collapse:separate; border-spacing:0}
    th,td{padding:10px 10px; font-size:13px; border-bottom:1px solid rgba(255,255,255,.16); text-align:left}
    th{ color: rgba(255,255,255,.86); font-weight:1000; background: rgba(0,0,0,.10); }
    tr:last-child td{border-bottom:none}

    .pill{
      font-size:12px;
      font-weight:1100;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
    }
    .pill.A{color:#ffe08a}
    .pill.B{color:#b8d7ff}
    .pill.C{color:#a6ffca}
    .pill.D,.pill.E,.pill.F{color:#ffffff}
    .pill.LAST{color:#ffd1dc}

    /* ✅ 彩帶 canvas 疊在最上層 */
    #fxCanvas{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:9999;
    }

    /* ====== 依獎級變色（卡片主體/邊框/徽章）====== */
    #revealCard{
      --tier1: rgba(255,255,255,.10);
      --tier2: rgba(255,255,255,.06);
      --tierGlow: rgba(255,255,255,.12);
      --tierBorder: rgba(255,255,255,.25);
      --tierText: rgba(255,255,255,.90);
    }

    #revealCard .face{
      background:
        radial-gradient(900px 420px at 20% 0%, var(--tier1), transparent 60%),
        radial-gradient(900px 420px at 80% 10%, var(--tier2), transparent 62%);
    }

    #revealCard::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      background:
        radial-gradient(700px 260px at 50% 0%, var(--tierGlow), transparent 60%),
        radial-gradient(520px 220px at 20% 30%, var(--tierGlow), transparent 65%),
        radial-gradient(520px 220px at 80% 30%, var(--tierGlow), transparent 65%);
      filter: blur(18px);
      opacity:.55;
    }

    #revealCard .badge{
      border-color: var(--tierBorder);
      color: var(--tierText);
      background: rgba(255,255,255,.10);
    }

    #revealCard .big{
      text-shadow:
        0 10px 40px rgba(0,0,0,.35),
        0 0 30px var(--tierGlow);
    }

    #revealCard[data-tier="A"]{
      --tier1: rgba(251,191,36,.32);
      --tier2: rgba(244,114,182,.18);
      --tierGlow: rgba(251,191,36,.22);
      --tierBorder: rgba(251,191,36,.55);
      --tierText: rgba(255,240,200,.95);
    }

    #revealCard[data-tier="B"]{
      --tier1: rgba(147,197,253,.26);
      --tier2: rgba(34,211,238,.18);
      --tierGlow: rgba(34,211,238,.20);
      --tierBorder: rgba(34,211,238,.55);
      --tierText: rgba(235,250,255,.95);
    }

    #revealCard[data-tier="C"]{
      --tier1: rgba(134,239,172,.24);
      --tier2: rgba(244,114,182,.16);
      --tierGlow: rgba(134,239,172,.18);
      --tierBorder: rgba(134,239,172,.55);
      --tierText: rgba(235,255,245,.95);
    }

    #revealCard[data-tier="D"],
    #revealCard[data-tier="E"],
    #revealCard[data-tier="F"]{
      --tier1: rgba(255,255,255,.12);
      --tier2: rgba(255,255,255,.06);
      --tierGlow: rgba(255,255,255,.14);
      --tierBorder: rgba(255,255,255,.28);
      --tierText: rgba(255,255,255,.90);
    }

    #revealCard[data-tier="LAST"]{
      --tier1: rgba(244,114,182,.22);
      --tier2: rgba(251,191,36,.20);
      --tierGlow: rgba(244,114,182,.20);
      --tierBorder: rgba(244,114,182,.55);
      --tierText: rgba(255,235,245,.95);
    }

    #revealCard[data-tier="NONE"]{
      --tier1: rgba(255,255,255,.08);
      --tier2: rgba(255,255,255,.04);
      --tierGlow: rgba(255,255,255,.10);
      --tierBorder: rgba(255,255,255,.22);
      --tierText: rgba(255,255,255,.86);
    }
  </style>
</head>

<body>
  <canvas id="fxCanvas"></canvas>

  <div class="wrap">
    <div class="hero">
      <div>
        <h1>一番賞抽獎 <span class="accentText">依獎級變色＋彩帶＋音效</span></h1>
        <p class="sub">
          填角色名 → 抽獎翻牌揭曉 → 自動扣庫。<span class="hint">最後一位會「額外加碼」最後賞。</span><br>
          <span class="mono">資料會存在本機 localStorage</span>（重整不會消失）。<br>
          <span class="hint">⚠ 抽獎音效不可關閉（按下抽獎就會播）。</span>
        </p>
      </div>
      <div class="row">
        <input id="playerName" placeholder="請輸入角色名字（必填）" maxlength="24" />
        <button class="primary" id="drawBtn">抽一發！</button>
        <button class="secondary" id="exportBtn">匯出紀錄</button>
        <button class="secondary" id="resetBtn" title="會重置庫存與紀錄">重置整池</button>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <div class="hd">
          <div style="display:flex; gap:10px; align-items:center;">
            <strong>翻牌揭曉</strong>
            <span class="tag" id="statusTag">剩餘 — / —</span>
          </div>
          <span class="tag" id="lastTag">最後賞：保留中（最後加碼）</span>
        </div>

        <div class="reveal">
          <div class="card" id="revealCard" data-tier="NONE" aria-live="polite">
            <div class="flash" id="flashBar"></div>
            <div class="face">
              <div class="title">
                <span>等待抽獎</span>
                <span class="badge" id="drawMeta">尚未抽出</span>
              </div>

              <div class="big" id="prizeBig">—</div>

              <div class="desc" id="prizeDesc">
                請先輸入角色名字，然後按「抽一發！」\n
                抽到的獎項會從池子移除，不會重複。\n
                最後一位抽的人會額外拿到「最後賞」加碼。
              </div>

              <div class="desc">抽獎者：<span class="who" id="whoText">（尚未）</span></div>
            </div>
          </div>
        </div>

        <div class="bd">
          <p class="note">
            小提醒：純前端版不防作弊（可清 localStorage / 改 JS）。如果要防作弊，建議改成 Google Sheets / Apps Script 做後端紀錄與扣庫。
          </p>
        </div>
      </section>

      <section class="panel">
        <div class="hd">
          <strong>庫存與紀錄</strong>
          <span class="tag" id="poolTag">獎池就緒</span>
        </div>

        <div class="bd" style="padding:0">
          <table>
            <thead>
              <tr>
                <th style="width:92px;">類別</th>
                <th>獎項</th>
                <th style="width:70px;">剩餘</th>
              </tr>
            </thead>
            <tbody id="poolTable"></tbody>
          </table>
        </div>

        <div class="bd">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="tag" id="logTag">已抽 0 人</span>
            <button class="danger" id="undoBtn" title="回復上一抽（主持人救援用）">撤回上一抽</button>
          </div>
          <div class="note" id="lastLogNote" style="margin-top:8px;"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
/**
 * 一番賞抽獎（純前端）
 * ✅ 最後賞 = 最後一位加碼（bonus），不取代最後一抽。
 * ✅ A/B/C 會有不同彩帶動畫。
 * ✅ 抽獎音效不可關閉：每次抽獎按鈕觸發都會播（使用 Web Audio 合成）。
 * ✅ 依獎級變色：卡片依 data-tier 切換色調
 */

const STORAGE_KEY = "ichiban_lottery_v4_bonus_last_confetti_sound_tier";

/** ✅ 你指定：F = 13，A~F 合計 32 抽 / 32 人 */
const PRIZES = [
  { key: "A",    label: "A賞",    desc: "2580時裝 × 1套", count: 1 },
  { key: "B",    label: "B賞",    desc: "1280時裝 × 1套", count: 2 },
  { key: "C",    label: "C賞",    desc: "680時裝 × 1套",  count: 3 },
  { key: "D",    label: "D賞",    desc: "300長鳴珠",      count: 5 },
  { key: "E",    label: "E賞",    desc: "180長鳴珠",      count: 8 },
  { key: "F",    label: "F賞",    desc: "60長鳴珠",       count: 13 },
  { key: "LAST", label: "最後賞", desc: "3000長鳴珠（最後一位加碼）", count: 1, isLast: true },
];

// ---------- state ----------
function buildInitialState(){
  const pool = {};
  for (const p of PRIZES) pool[p.key] = p.count;
  return {
    pool,
    logs: [],      // {idx, name, prizeKey, prizeLabel, prizeDesc, at, lastBonus}
    usedNames: {}, // name -> true
    createdAt: new Date().toISOString(),
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return buildInitialState();
    const st = JSON.parse(raw);
    if(!st.pool || !st.logs || !st.usedNames) return buildInitialState();
    return st;
  }catch(e){
    return buildInitialState();
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// 抽獎人數只算 A~F（不含 LAST）
function totalAll(){
  return PRIZES.filter(p => p.key !== "LAST")
               .reduce((a,p)=>a+p.count,0);
}
function remainingNonLast(){
  return Object.entries(state.pool)
    .filter(([k]) => k !== "LAST")
    .reduce((a,[,v]) => a+v, 0);
}
function totalRemaining(){ return remainingNonLast(); }

function nowFmt(){
  const d = new Date();
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function buildTicketsNonLast(){
  const tickets = [];
  for (const p of PRIZES){
    if(p.key === "LAST") continue;
    const left = state.pool[p.key] || 0;
    for(let i=0;i<left;i++) tickets.push(p.key);
  }
  return tickets;
}
function pickRandom(arr){
  const i = Math.floor(Math.random()*arr.length);
  return arr[i];
}
function prizeInfo(key){
  const p = PRIZES.find(x=>x.key===key);
  return p ? p : { key, label:key, desc:"" };
}

// ---------- DOM ----------
const $ = (id)=>document.getElementById(id);

const fxCanvas = $("fxCanvas");

const playerName = $("playerName");
const drawBtn = $("drawBtn");
const exportBtn = $("exportBtn");
const resetBtn = $("resetBtn");
const undoBtn = $("undoBtn");

const statusTag = $("statusTag");
const lastTag = $("lastTag");
const poolTag = $("poolTag");
const poolTable = $("poolTable");
const logTag = $("logTag");
const lastLogNote = $("lastLogNote");

const revealCard = $("revealCard");
const flashBar = $("flashBar");
const drawMeta = $("drawMeta");
const prizeBig = $("prizeBig");
const prizeDesc = $("prizeDesc");
const whoText = $("whoText");

// ---------- Tier Visual (依獎級變色) ----------
function setTierVisual(tier){
  // tier: "A"|"B"|"C"|"D"|"E"|"F"|"LAST"|"NONE"
  revealCard.dataset.tier = tier || "NONE";
}

// ---------- 音效（不可關閉） ----------
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if(audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
}
function playDrawSfx(tier, hasLastBonus){
  ensureAudio();
  const ctx = audioCtx;
  const t0 = ctx.currentTime + 0.01;

  const master = ctx.createGain();
  master.gain.value = 0.55;
  master.connect(ctx.destination);

  const click = (time, freq, dur, type="triangle", gain=0.22) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, time);
    g.gain.setValueAtTime(gain, time);
    g.gain.exponentialRampToValueAtTime(0.0001, time + dur);
    o.connect(g); g.connect(master);
    o.start(time); o.stop(time + dur + 0.02);
  };

  const whoosh = (time, dur=0.18, gain=0.16) => {
    const bufferSize = Math.floor(ctx.sampleRate * dur);
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++){
      data[i] = (Math.random()*2-1) * (1 - i/bufferSize);
    }
    const src = ctx.createBufferSource();
    src.buffer = buffer;

    const g = ctx.createGain();
    g.gain.setValueAtTime(gain, time);
    g.gain.exponentialRampToValueAtTime(0.0001, time + dur);

    const f = ctx.createBiquadFilter();
    f.type = "highpass";
    f.frequency.setValueAtTime(900, time);

    src.connect(f); f.connect(g); g.connect(master);
    src.start(time); src.stop(time + dur + 0.02);
  };

  const lowThump = (time) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(90, time);
    o.frequency.exponentialRampToValueAtTime(45, time + 0.16);
    g.gain.setValueAtTime(0.32, time);
    g.gain.exponentialRampToValueAtTime(0.0001, time + 0.18);
    o.connect(g); g.connect(master);
    o.start(time); o.stop(time + 0.22);
  };

  // 每次抽都有一個 whoosh + click
  whoosh(t0, 0.16, 0.15);
  click(t0 + 0.02, 480, 0.07, "square", 0.10);

  if(tier === "F" || tier === "E" || tier === "D"){
    click(t0 + 0.08, 620, 0.10, "triangle", 0.18);
  }else if(tier === "C"){
    click(t0 + 0.06, 660, 0.10, "triangle", 0.18);
    click(t0 + 0.16, 880, 0.10, "triangle", 0.18);
    click(t0 + 0.26, 1100, 0.12, "triangle", 0.18);
  }else if(tier === "B"){
    click(t0 + 0.06, 740, 0.11, "triangle", 0.20);
    click(t0 + 0.16, 1040, 0.11, "triangle", 0.20);
    click(t0 + 0.26, 1480, 0.14, "triangle", 0.22);
    click(t0 + 0.40, 1760, 0.12, "sine", 0.18);
  }else if(tier === "A"){
    lowThump(t0 + 0.02);
    click(t0 + 0.08, 780, 0.12, "triangle", 0.22);
    click(t0 + 0.20, 1180, 0.12, "triangle", 0.24);
    click(t0 + 0.32, 1680, 0.14, "triangle", 0.26);
    click(t0 + 0.48, 2100, 0.18, "sine", 0.20);
    whoosh(t0 + 0.12, 0.22, 0.16);
  }

  if(hasLastBonus){
    click(t0 + 0.62, 1320, 0.12, "sine", 0.18);
    click(t0 + 0.76, 1560, 0.12, "sine", 0.18);
    click(t0 + 0.90, 1960, 0.16, "sine", 0.20);
  }
}

// ---------- 彩帶 FX（A/B/C 專屬） ----------
const fx = fxCanvas.getContext("2d");
let W = 0, H = 0;
let particles = [];
let rafId = null;

function resizeFx(){
  W = fxCanvas.width = Math.floor(window.innerWidth * devicePixelRatio);
  H = fxCanvas.height = Math.floor(window.innerHeight * devicePixelRatio);
  fx.setTransform(1,0,0,1,0,0);
}
window.addEventListener("resize", resizeFx);
resizeFx();

function rand(a,b){ return a + Math.random()*(b-a); }

function spawnConfettiBurst(mode){
  const base = { x: rand(W*0.25, W*0.75), y: rand(H*0.12, H*0.22) };

  const paletteA = ["#ffd54a","#fff2b0","#ff77c8","#7c3aed","#22d3ee"];
  const paletteB = ["#9bd2ff","#22d3ee","#b8d7ff","#f472b6","#e9eeff"];
  const paletteC = ["#a6ffca","#86efac","#f472b6","#ffe08a","#e9eeff"];
  const paletteLast = ["#ffd1dc","#ffd54a","#22d3ee","#f472b6","#ffffff"];

  let count = 0, power = 0, spin = 0, grav = 0, drag = 0;
  let shapes = ["rect"];
  let colors = paletteC;

  if(mode === "A"){
    count = 220; power = 22; spin = 18; grav = 0.22; drag = 0.992;
    shapes = ["rect","rect","star"]; colors = paletteA;
  }else if(mode === "B"){
    count = 160; power = 18; spin = 14; grav = 0.24; drag = 0.991;
    shapes = ["rect","rect","circle"]; colors = paletteB;
  }else if(mode === "C"){
    count = 120; power = 15; spin = 12; grav = 0.26; drag = 0.990;
    shapes = ["rect","heart","circle"]; colors = paletteC;
  }else if(mode === "LAST"){
    count = 200; power = 20; spin = 16; grav = 0.23; drag = 0.992;
    shapes = ["star","star","rect","circle"]; colors = paletteLast;
  }else{
    count = 60; power = 12; spin = 10; grav = 0.28; drag = 0.988;
    shapes = ["rect"]; colors = ["#ffffff","#b8d7ff","#a6ffca","#ffd54a"];
  }

  for(let i=0;i<count;i++){
    const a = rand(-Math.PI, Math.PI);
    const sp = rand(power*0.35, power);
    const vx = Math.cos(a)*sp * devicePixelRatio;
    const vy = Math.sin(a)*sp * devicePixelRatio;

    const shape = shapes[Math.floor(Math.random()*shapes.length)];
    const size = (shape === "rect") ? rand(6, 14) : rand(6, 12);
    const w = size * devicePixelRatio;
    const h = rand(4, 10) * devicePixelRatio;

    particles.push({
      x: base.x, y: base.y,
      vx, vy,
      r: rand(0, Math.PI*2),
      vr: rand(-spin, spin) * 0.02,
      w, h,
      shape,
      color: colors[Math.floor(Math.random()*colors.length)],
      life: 1.0,
      drag,
      grav: grav * devicePixelRatio,
      sparkle: (mode==="A"||mode==="LAST") ? rand(0.15,0.45) : rand(0.05,0.25),
    });
  }

  startFxLoop();
}

function drawStar(cx, cy, spikes, outerR, innerR, rot){
  fx.save();
  fx.translate(cx, cy);
  fx.rotate(rot);
  fx.beginPath();
  let a = -Math.PI/2;
  const step = Math.PI / spikes;
  for(let i=0;i<spikes*2;i++){
    const r = (i%2===0) ? outerR : innerR;
    fx.lineTo(Math.cos(a)*r, Math.sin(a)*r);
    a += step;
  }
  fx.closePath();
  fx.fill();
  fx.restore();
}
function drawHeart(cx, cy, s, rot){
  fx.save();
  fx.translate(cx, cy);
  fx.rotate(rot);
  fx.beginPath();
  const x = 0, y = 0;
  fx.moveTo(x, y + s*0.25);
  fx.bezierCurveTo(x, y, x - s*0.6, y, x - s*0.6, y + s*0.35);
  fx.bezierCurveTo(x - s*0.6, y + s*0.75, x, y + s*0.90, x, y + s*1.10);
  fx.bezierCurveTo(x, y + s*0.90, x + s*0.6, y + s*0.75, x + s*0.6, y + s*0.35);
  fx.bezierCurveTo(x + s*0.6, y, x, y, x, y + s*0.25);
  fx.closePath();
  fx.fill();
  fx.restore();
}

function startFxLoop(){
  if(rafId) return;
  const step = ()=>{
    rafId = requestAnimationFrame(step);

    fx.clearRect(0,0,W,H);

    // 輕拖影
    fx.save();
    fx.globalAlpha = 0.08;
    fx.fillStyle = "rgba(0,0,0,0.35)";
    fx.fillRect(0,0,W,H);
    fx.restore();

    const next = [];
    for(const p of particles){
      p.vx *= p.drag;
      p.vy *= p.drag;
      p.vy += p.grav;

      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;

      p.life -= 0.010;
      if(p.life <= 0) continue;

      const sparkle = 0.85 + Math.sin((1-p.life)*14 + p.x*0.002)*p.sparkle;
      fx.globalAlpha = Math.max(0, Math.min(1, p.life)) * sparkle;

      fx.fillStyle = p.color;

      if(p.shape === "rect"){
        fx.save();
        fx.translate(p.x, p.y);
        fx.rotate(p.r);
        fx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
        fx.restore();
      }else if(p.shape === "circle"){
        fx.beginPath();
        fx.arc(p.x, p.y, Math.max(2, p.w*0.30), 0, Math.PI*2);
        fx.fill();
      }else if(p.shape === "star"){
        drawStar(p.x, p.y, 5, Math.max(4,p.w*0.55), Math.max(2,p.w*0.25), p.r);
      }else if(p.shape === "heart"){
        drawHeart(p.x, p.y, Math.max(5,p.w*0.55), p.r);
      }

      if(p.y < H*1.25 && p.x > -W*0.25 && p.x < W*1.25){
        next.push(p);
      }
    }
    particles = next;

    if(particles.length === 0){
      cancelAnimationFrame(rafId);
      rafId = null;
      fx.clearRect(0,0,W,H);
    }
  };
  rafId = requestAnimationFrame(step);
}

function fxForPrize(prizeKey, lastBonus){
  if(lastBonus) spawnConfettiBurst("LAST");
  if(prizeKey === "A") spawnConfettiBurst("A");
  else if(prizeKey === "B") spawnConfettiBurst("B");
  else if(prizeKey === "C") spawnConfettiBurst("C");
  else spawnConfettiBurst("SMALL");
}

// ---------- UI ----------
let state = loadState();
setTierVisual("NONE");
renderAll();

function renderAll(){
  renderStatus();
  renderPoolTable();
  renderLogsSummary();
  renderButtonsState();
}
function renderStatus(){
  const rem = totalRemaining();
  statusTag.textContent = `剩餘 ${rem} / ${totalAll()}`;

  const lastLeft = state.pool["LAST"] || 0;
  lastTag.textContent = (lastLeft === 1)
    ? `最後賞：保留中（最後一位加碼）`
    : `最後賞：已送出（最後一位）`;

  poolTag.textContent = (rem === 0) ? "抽獎已結束" : "獎池進行中";
}
function renderPoolTable(){
  poolTable.innerHTML = "";
  for (const p of PRIZES){
    const left = state.pool[p.key] ?? 0;
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    const pill = document.createElement("span");
    pill.className = `pill ${p.key}`;
    pill.textContent = p.label;
    td1.appendChild(pill);

    const td2 = document.createElement("td");
    td2.textContent = p.desc;

    const td3 = document.createElement("td");
    td3.textContent = left;

    tr.append(td1, td2, td3);
    poolTable.appendChild(tr);
  }
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function renderLogsSummary(){
  logTag.textContent = `已抽 ${state.logs.length} 人`;
  const last = state.logs[state.logs.length - 1];
  if(!last){
    lastLogNote.textContent = "尚未有人抽獎。";
    return;
  }
  const bonusText = last.lastBonus ? ` ＋ <span class="pill LAST">最後賞</span>` : "";
  lastLogNote.innerHTML = `
    上一抽：<span class="mono">${escapeHtml(last.name)}</span> → 
    <span class="pill ${last.prizeKey}">${escapeHtml(last.prizeLabel)}</span>${bonusText}
    <span class="mono">（#${last.idx}）</span><br>
    <span class="note mono">${escapeHtml(last.at)}</span>
  `;
}
function renderButtonsState(){
  const rem = totalRemaining();
  drawBtn.disabled = rem === 0;
  undoBtn.disabled = state.logs.length === 0;
}

function animateReveal(){
  revealCard.classList.remove("flip","glow");
  flashBar.classList.remove("on");
  void revealCard.offsetWidth;
  revealCard.classList.add("flip","glow");
  flashBar.classList.add("on");
}

function normalizeName(name){
  return name.trim().replace(/\s+/g," ");
}
function canDraw(name){
  if(!name) return { ok:false, msg:"請先輸入角色名字。" };
  if(name.length < 2) return { ok:false, msg:"角色名字太短啦（至少 2 字）。" };
  if(state.usedNames[name]) return { ok:false, msg:"這個角色名已抽過了（避免重複抽）。" };
  if(totalRemaining() <= 0) return { ok:false, msg:"獎池已抽完。" };
  return { ok:true };
}

/** 核心：永遠抽 A~F；若這抽後 A~F 剩 0 => 這人額外拿最後賞 */
function doDraw(name){
  const drawIndex = state.logs.length + 1;
  if(remainingNonLast() <= 0) return null;

  const tickets = buildTicketsNonLast();
  const prizeKey = pickRandom(tickets);

  state.pool[prizeKey] = (state.pool[prizeKey] || 0) - 1;
  if(state.pool[prizeKey] < 0) state.pool[prizeKey] = 0;

  const isLastDrawer = (remainingNonLast() === 0);
  const giveLastBonus = isLastDrawer && (state.pool["LAST"] || 0) === 1;
  if(giveLastBonus) state.pool["LAST"] = 0;

  const info = prizeInfo(prizeKey);
  const log = {
    idx: drawIndex,
    name,
    prizeKey,
    prizeLabel: info.label,
    prizeDesc: info.desc,
    at: nowFmt(),
    lastBonus: giveLastBonus,
  };

  state.logs.push(log);
  state.usedNames[name] = true;
  saveState();
  return log;
}

function showReveal(log){
  if(!log) return;

  // ✅ 先依本次獎級上色
  setTierVisual(log.prizeKey);

  drawMeta.textContent = `第 #${log.idx} 抽`;
  whoText.textContent = log.name;

  if(log.lastBonus){
    prizeBig.textContent = `${log.prizeLabel} ＋ 最後賞！`;
    prizeDesc.textContent = `${log.prizeDesc}\n（加碼）最後賞：3000長鳴珠`;

    // ✅ 加碼最後賞時，強制切到 LAST 色盤（更像加碼）
    setTierVisual("LAST");
  }else{
    prizeBig.textContent = `${log.prizeLabel}！`;
    prizeDesc.textContent = log.prizeDesc;
  }

  animateReveal();
}

// ---------- Events ----------
drawBtn.addEventListener("click", ()=>{
  const name = normalizeName(playerName.value);
  const ok = canDraw(name);

  // ✅ 抽獎音效不可關閉：按抽獎就會播（錯誤也播）
  if(!ok.ok){
    playDrawSfx("F", false);
    setTierVisual("NONE");
    drawMeta.textContent = "無法抽獎";
    prizeBig.textContent = "—";
    prizeDesc.textContent = ok.msg;
    whoText.textContent = name || "（未填）";
    animateReveal();
    return;
  }

  const log = doDraw(name);

  // ✅ 先播音效，再顯示結果（更有開獎感）
  playDrawSfx(log.prizeKey, log.lastBonus);

  showReveal(log);
  fxForPrize(log.prizeKey, log.lastBonus);

  renderAll();
  playerName.value = "";
  playerName.focus();
});

exportBtn.addEventListener("click", ()=>{
  const data = { exportedAt: new Date().toISOString(), state };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `lottery_export_${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

resetBtn.addEventListener("click", ()=>{
  if(!confirm("確定要重置整池？（庫存與紀錄都會清空）")) return;

  state = buildInitialState();
  saveState();

  setTierVisual("NONE");
  drawMeta.textContent = "尚未抽出";
  prizeBig.textContent = "—";
  prizeDesc.textContent = "已重置。請輸入角色名字後再抽。";
  whoText.textContent = "（尚未）";
  animateReveal();

  renderAll();
});

undoBtn.addEventListener("click", ()=>{
  const last = state.logs.pop();
  if(!last) return;

  state.pool[last.prizeKey] = (state.pool[last.prizeKey] || 0) + 1;
  if(last.lastBonus){
    state.pool["LAST"] = 1;
  }

  const stillUsed = state.logs.some(x => x.name === last.name);
  if(!stillUsed) delete state.usedNames[last.name];

  saveState();

  setTierVisual("NONE");
  drawMeta.textContent = "已撤回上一抽";
  prizeBig.textContent = "—";
  prizeDesc.textContent = `已撤回：${last.name}（第 #${last.idx} 抽）`;
  whoText.textContent = "（尚未）";
  animateReveal();

  renderAll();
});

// Enter 直接抽
playerName.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") drawBtn.click();
});
  </script>
</body>
</html>
